import cv2
from detection import AccidentDetectionModel
import numpy as np
import os
import requests
import time

# Initialize the accident detection model
model = AccidentDetectionModel("model.json", "model_weights.h5")
font = cv2.FONT_HERSHEY_SIMPLEX

# Telegram Bot credentials
bot_token = "8127214054:AAEDG5Id3QfqV0CKFcbmGHm-lREu8IxZ7Us"  # Replace with your valid Telegram Bot token
chat_id_alert = "1172570965"  # Receiver of the alert (e.g., emergency contact)
chat_id_report = "5229167971"  # Receiver of the detailed report (e.g., user)

report_sent = False  # Flag to ensure the report is sent only once

# Function to send a message via Telegram
def send_telegram_message(message, chat_id):
    url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
    params = {"chat_id": chat_id, "text": message}
    
    try:
        response = requests.post(url, data=params)
        response.raise_for_status()  # Raise an error for failed requests
        print("Message sent successfully!")
    except requests.exceptions.RequestException as e:
        print(f"Failed to send message: {e}")

# Function to send an image via Telegram
def send_telegram_image(image_path, chat_id):
    url = f"https://api.telegram.org/bot{bot_token}/sendPhoto"
    
    try:
        with open(image_path, "rb") as image:
            files = {"photo": image}
            data = {"chat_id": chat_id}
            response = requests.post(url, files=files, data=data)
            response.raise_for_status()
            print("Image sent successfully!")
    except requests.exceptions.RequestException as e:
        print(f"Failed to send image: {e}")

# Function to generate a detailed accident report suitable for insurance claims
def generate_report(location, vehicle_id, timestamp, accident_type="Hit-and-run",
                     other_vehicle_id="Unknown", driver_name="Unknown",
                     driver_contact="Unknown", insurance_provider="Unknown"):
    report = (
        "Accident Report (For Insurance Claim):\n\n"
        "**Incident Details:**\n"
        f"Incident Type: {accident_type}\n"
        f"Date and Time: {timestamp}\n"
        f"Location: {location}\n\n"

        "**Your Vehicle Details:**\n"
        f"Vehicle ID: {vehicle_id}\n\n"

        "**Other Vehicle Details (if applicable):**\n"
        f"Other Vehicle ID: {other_vehicle_id}\n\n"

        "**Other Driver Details (if available):**\n"
        f"Driver's Name: {driver_name}\n"
        f"Driver's Contact: {driver_contact}\n"
        f"Insurance Provider: {insurance_provider}\n\n"

        "**Additional Information:**\n"
        "Please use this report for your insurance claim.  \n"
        "A photo of the accident scene is attached (if available).\n\n"
        "**Disclaimer:** This report is generated automatically and may not include all details.  Please consult with relevant authorities and insurance providers for complete assessment.\n"
    )
    return report

# Function to start the accident detection and alert system
def startapplication():
    global report_sent
    video = cv2.VideoCapture(r"D:\\SET\\Accident-Detection-System-main\\Bike.mp4")
    
    # Variables to track accident state
    accident_detected = False  # Flag to track if an accident is ongoing
    last_accident_frame = None  # To store the last frame of the accident
    last_alert_time = 0  # Timestamp of the last alert
    cooldown_period = 60  # Cooldown period in seconds

    while True:
        ret, frame = video.read()
        if not ret or frame is None:
            print("Error: No frame captured. Skipping frame...")
            continue

        # Preprocess input frame
        gray_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        roi = cv2.resize(gray_frame, (250, 250))

        # Accident detection prediction
        pred, prob = model.predict_accident(roi[np.newaxis, :, :, :])
        print(f"Raw Prediction Output: {pred}, Probability: {prob}")

        # Adjusted probability threshold for better detection
        accident_threshold = 95  # Increased threshold to reduce false positives
        accident_prob = prob[0][0]  # Probability of "Accident"
        no_accident_prob = prob[0][1]  # Probability of "No Accident"

        if accident_prob > no_accident_prob and accident_prob * 100 > accident_threshold:
            # Accident detected
            prob = round(accident_prob * 100, 2)

            # Display the prediction and probability on the frame
            cv2.rectangle(frame, (0, 0), (280, 40), (0, 0, 0), -1)
            cv2.putText(frame, f"{pred} {prob}%", (20, 30), font, 1, (255, 255, 0), 2)

            # Update the accident state and store the last frame
            accident_detected = True
            last_accident_frame = frame.copy()  # Store the current frame as the last accident frame

        else:
            # No accident detected
            if accident_detected:
                # Accident has ended, send the last frame
                print("Accident occured. Sending the last frame.")

                # Generate details for the report
                location = "Pollachi"
                vehicle_id = "XYZ123"
                timestamp = time.strftime("%Y-%m-%d %H:%M:%S", time.gmtime())

                # Generate a detailed accident report
                if not report_sent:
                    detailed_report = generate_report(location, vehicle_id, timestamp)
                    send_telegram_message(detailed_report, chat_id_report)
                    report_sent = True

                # Format the alert message
                alert_message = (
                    f"URGENT: Accident Detected!\n"
                    f"Location: {location}\n"
                    f"Vehicle ID: {vehicle_id}\n"
                    f"Timestamp: {timestamp}\n"
                    f"Immediate action required!"
                )

                # Save the last accident frame as an image
                if last_accident_frame is not None:
                    image_path = "last_accident_frame.jpg"
                    cv2.imwrite(image_path, last_accident_frame)

                    # Send Telegram alert to emergency contact (with image)
                    send_telegram_message(alert_message, chat_id_alert)
                    send_telegram_image(image_path, chat_id_alert)

                    # Send the same image to the user (chat_id_report)
                    send_telegram_image(image_path, chat_id_report)

                # Reset the accident state
                accident_detected = False
                last_accident_frame = None

        # Exit on pressing 'q'
        if cv2.waitKey(100) & 0xFF == ord('q'):
            break

        # Show the video frame with prediction info
        cv2.imshow("Video", frame)

    # Release resources
    video.release()
    cv2.destroyAllWindows()